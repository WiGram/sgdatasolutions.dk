<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastAPI Audit Logging - SG Data Solutions</title>
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    
    <!-- Your CSS -->
    <link rel="stylesheet" href="/src/css/style.css">
    
    <!-- Bootstrap Icons CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Prism.js for code highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-python.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <!-- Brand -->
            <a class="navbar-brand" href="#">SG Data Solutions</a>
            
            <!-- Mobile Toggle Button -->
            <button 
                class="navbar-toggler" 
                type="button" 
                data-bs-toggle="collapse" 
                data-bs-target="#navbarNav" 
                aria-controls="navbarNav" 
                aria-expanded="false" 
                aria-label="Toggle navigation"
            >
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <!-- Navigation Items -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#hero">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#about">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#competencies">Competencies</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#cv">CV</a>
                    </li>
                    <li class="nav-item has-megamenu">
                        <!-- Mobile/small screen version -->
                        <a class="nav-link d-lg-none" href="#" data-bs-toggle="collapse" data-bs-target="#projectsSubmenu" aria-expanded="false">
                            Projects
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <div class="submenu collapse" id="projectsSubmenu">
                            <!-- "View All" link at the top -->
                            <a href="/#projects" class="menu-header">
                                View All Projects
                                <i class="bi bi-arrow-right"></i>
                            </a>
                            <div class="menu-items">
                                <a href="/projects/regulatory-reporting/" class="menu-item">
                                    <h4>Regulatory Reporting</h4>
                                    <p>Enterprise data warehouse solution for regulatory reporting</p>
                                    <div class="tags">
                                        <span class="badge bg-primary">Financial Services</span>
                                        <span class="badge bg-secondary">Data Migration</span>
                                    </div>
                                </a>
                                <a href="/projects/performance-pay/" class="menu-item">
                                    <h4>Performance Pay</h4>
                                    <p>Data-driven transformation of performance pay structures</p>
                                    <div class="tags">
                                        <span class="badge bg-info">HR Analytics</span>
                                        <span class="badge bg-success">Financial Modeling</span>
                                    </div>
                                </a>
                            </div>
                        </div>

                        <!-- Large screen version -->
                        <a class="nav-link d-none d-lg-block" href="/#projects">
                            Projects
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <div class="megamenu d-none d-lg-block">
                            <div class="container">
                                <div class="menu-items">
                                    <a href="/projects/regulatory-reporting/" class="menu-item">
                                        <h4>Regulatory Reporting</h4>
                                        <p>Enterprise data warehouse solution for regulatory reporting</p>
                                        <div class="tags">
                                            <span class="badge bg-primary">Financial Services</span>
                                            <span class="badge bg-secondary">Data Migration</span>
                                        </div>
                                    </a>
                                    <a href="/projects/performance-pay/" class="menu-item">
                                        <h4>Performance Pay</h4>
                                        <p>Data-driven transformation of performance pay structures</p>
                                        <div class="tags">
                                            <span class="badge bg-info">HR Analytics</span>
                                            <span class="badge bg-success">Financial Modeling</span>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </li>
                    <li class="nav-item has-megamenu">
                        <!-- Mobile/small screen version -->
                        <a class="nav-link d-lg-none" href="#" data-bs-toggle="collapse" data-bs-target="#blogSubmenu" aria-expanded="false">
                            Blog
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <div class="submenu collapse" id="blogSubmenu">
                            <!-- "View All" link at the top -->
                            <a href="/#blog" class="menu-header">
                                View All Blog Posts
                                <i class="bi bi-arrow-right"></i>
                            </a>
                            <div class="menu-items">
                                <a href="/blog_posts/api-audit-logging/" class="menu-item">
                                    <h4>API Audit Logging</h4>
                                    <p>Data-driven transformation...</p>
                                    <div class="tags">
                                        <span class="badge bg-primary">FastAPI</span>
                                        <span class="badge bg-secondary">Logging</span>
                                        <span class="badge bg-info">Audit</span>
                                    </div>
                                </a>
                            </div>
                        </div>

                        <!-- Large screen version -->
                        <a class="nav-link d-none d-lg-block" href="/#blog">
                            Blog
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <div class="megamenu d-none d-lg-block">
                            <div class="container">
                                <div class="menu-items">
                                    <a href="/blog_posts/api-audit-logging/" class="menu-item">
                                        <h4>API Audit Logging</h4>
                                        <p>Data-driven transformation...</p>
                                        <div class="tags">
                                            <span class="badge bg-primary">FastAPI</span>
                                            <span class="badge bg-secondary">Logging</span>
                                            <span class="badge bg-info">Audit</span>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#contact">Contact</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <article class="blog-post">
        <header class="blog-header">
            <div class="container">
                <div class="breadcrumb-nav mb-4">
                    <a href="/#blog" class="back-button">
                        <i class="bi bi-arrow-left-circle-fill"></i> Back to Blog
                    </a>
                </div>
                <div class="blog-meta">
                    <span class="badge bg-primary">API Development</span>
                    <span class="badge bg-secondary">FastAPI</span>
                    <span class="badge bg-info">Logging</span>
                    <span class="badge bg-success">Performance</span>
                    <span class="badge bg-warning text-dark">Azure</span>
                </div>
                <h1>Optimizing FastAPI Audit Logging: Balancing Performance and Compliance</h1>
                <p class="lead">A journey from blocking middleware to high-performance audit logging while maintaining security requirements.</p>
                <div class="milestone-cards">
                    <div class="milestone-card">
                        <i class="bi bi-exclamation-circle"></i>
                        <h3>Challenge</h3>
                        <p>Lack of audit logging</p>
                        <div class="metric">Must integrate with Azure Application Insights</div>
                        <span class="label">Constraint: unchanged endpoint performance</span>
                    </div>
                    <div class="milestone-card">
                        <i class="bi bi-lightning"></i>
                        <h3>Solution</h3>
                        <p>Async logging with Azure Application Insights</p>
                        <div class="metric">&lt;1ms</div>
                        <span class="label">Final Response Time</span>
                    </div>
                    <div class="milestone-card">
                        <i class="bi bi-check2-circle"></i>
                        <h3>Impact</h3>
                        <p>Full audit compliance with minimal overhead</p>
                        <div class="metric">100%</div>
                        <span class="label">Audit Coverage</span>
                    </div>
                </div>
            </div>
        </header>

        <div class="container">
            <div class="row">
                <!-- TOC -->
                <div class="col-lg-3 toc-wrapper">
                    <div class="toc-mobile">
                        <div class="card card--toc">
                            <nav class="nav flex-column">
                                <h4>Contents</h4>
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a class="nav-link" href="#introduction">Introduction</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#initial-setup">Setting Up Basic Audit Logging</a>
                                        <ul class="nav flex-column ms-3">
                                            <li class="nav-item">
                                                <a class="nav-link" href="#requirements">Initial Requirements</a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link" href="#implementation">First Implementation</a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#azure-insights">Integrating with Azure Application Insights</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#performance-issues">Addressing Performance Bottlenecks</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#final-solution">The Optimized Solution</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#lessons-learned">Key Takeaways</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- Main content -->
                <div class="col-lg-9">
                    <div class="blog-content">
                        <section id="introduction">
                            <h2>Introduction</h2>
                            <p>When building enterprise APIs, we often face competing requirements: comprehensive audit logging for security and compliance, while maintaining high-performance responses for end-users. This was exactly the challenge I faced when implementing a FastAPI-based data exchange API that needed to log detailed audit information to Azure Application Insights.</p>
                            
                            <p>In this post, I'll walk you through my journey from a basic blocking implementation to a high-performance solution that maintains full audit capabilities without compromising user experience.</p>
                        </section>

                        <section id="initial-setup">
                            <h2>Setting Up Basic Audit Logging</h2>
                            
                            <div class="card card--section">
                                <h3 class="card__title">Initial Requirements</h3>
                                <p class="card__content">The audit logging system needed to capture:</p>
                                <ul>
                                    <li>Request details (method, path, query parameters)</li>
                                    <li>User information from Azure AD tokens</li>
                                    <li>Request body content for POST/PUT operations</li>
                                    <li>Response status and timing</li>
                                    <li>Geographic location and client IP</li>
                                </ul>
                            </div>

                            <div class="card card--section">
                                <h3 class="card__title">First Implementation</h3>
                                <p class="card__content">Our initial approach used FastAPI's middleware system with a basic logging setup:</p>
                                
                                <div class="card card--code">
                                    <pre><code class="language-python card__content">
class AuditLoggingMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        # Basic logging implementation
        start_time = time()
        response = await call_next(request)
        duration = time() - start_time
        
        logging.info(f"Request: {request.method} {request.url.path}")
        return response
                                    </code></pre>
                                </div>

                                <p>While this worked, it lacked structured logging and proper integration with Azure Application Insights.</p>
                            </div>
                        </section>

                        <section id="azure-insights">
                            <h2>Integrating with Azure Application Insights</h2>
                            
                            <p>The next step was creating a custom handler to properly format our logs for Azure Application Insights:</p>

                            <div class="card card--code">
                                <pre><code class="language-python card__content">
class ApplicationInsightsHandler(AzureLogHandler):
    def __init__(self, connection_string):
        super().__init__(connection_string=connection_string)
        
    def emit(self, record):
        if hasattr(record, "custom_dimensions"):
            self.add_telemetry_processor(
                self._add_custom_dimensions(record.custom_dimensions)
            )
        super().emit(record)
                                </code></pre>
                            </div>

                            <p>This allowed us to send structured data with custom dimensions, making our logs more queryable and valuable for analysis.</p>
                        </section>

                        <section id="performance-issues">
                            <h2>Addressing Performance Bottlenecks</h2>
                            
                            <p>Our initial implementation had a significant issue: it was blocking the request while gathering all the audit information. With complex token decoding and body parsing, some requests were taking over 200ms just for logging!</p>

                            <p>The solution came in three parts:</p>
                            <ol>
                                <li>Parallel processing of the audit information</li>
                                <li>Asynchronous logging</li>
                                <li>Careful request body handling</li>
                            </ol>
                        </section>

                        <section id="final-solution">
                            <h2>The Optimized Solution</h2>
                            
                            <p>Our final implementation achieved both goals: comprehensive audit logging and minimal impact on response times. Key improvements included:</p>

                            <ul>
                                <li>Immediate request forwarding to reduce latency</li>
                                <li>Asynchronous token processing</li>
                                <li>Efficient body handling</li>
                                <li>Structured logging with custom dimensions</li>
                            </ul>

                            <p>The results were impressive: audit logging overhead dropped from 200+ms to less than 1ms per request.</p>
                        </section>

                        <section id="lessons-learned">
                            <h2>Key Takeaways</h2>
                            
                            <p>This journey taught several valuable lessons:</p>
                            <ul>
                                <li>Always measure performance impact of middleware</li>
                                <li>Use async operations whenever possible</li>
                                <li>Structure your logs for easy querying</li>
                                <li>Consider the end-user experience in every decision</li>
                            </ul>
                        </section>
                    </div>
                </div>
            </div>
        </div>
    </article>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="/src/js/main.js"></script>
</body>
</html> 